<!-- build time:Fri Apr 17 2020 15:54:03 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=no,email=no,adress=no"><meta name="theme-color" content="#000000"><meta http-equiv="window-target" content="_top"><title>MySQL基础篇-索引 | On The Way</title><meta name="description" content="深入浅出索引索引的出现其实就是为了提高数据查询的效率，就像书的目录一样。索引的常见模型索引的出现是为了提高查询效率，但是实现索引的方式却是有很多钟，所以这里也就引入了索引模型的概念。可以用于提高读写效率的数据结构很多，常见也比较简单的数据结构，它们分别是哈希表、有序数组和搜索树哈希表是一种以键-值（key-value）存储数据的结构，我们只要输入待查找的值即key，就可以找到其对应的值Value。"><meta name="keywords" content="MySQL"><meta property="og:type" content="article"><meta property="og:title" content="MySQL基础篇-索引"><meta property="og:url" content="https://vincentxin-scott.github.io/2020/01/31/数据库/mysql｜04深入浅出索引/index.html"><meta property="og:site_name" content="On The Way"><meta property="og:description" content="深入浅出索引索引的出现其实就是为了提高数据查询的效率，就像书的目录一样。索引的常见模型索引的出现是为了提高查询效率，但是实现索引的方式却是有很多钟，所以这里也就引入了索引模型的概念。可以用于提高读写效率的数据结构很多，常见也比较简单的数据结构，它们分别是哈希表、有序数组和搜索树哈希表是一种以键-值（key-value）存储数据的结构，我们只要输入待查找的值即key，就可以找到其对应的值Value。"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://raw.githubusercontent.com/vincentxin-scott/img/master/picgo/20200201152517.png"><meta property="og:image" content="https://raw.githubusercontent.com/vincentxin-scott/img/master/picgo/20200201153201.png"><meta property="og:image" content="https://raw.githubusercontent.com/vincentxin-scott/img/master/picgo/20200201175059.png"><meta property="og:updated_time" content="2020-02-03T11:41:01.677Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="MySQL基础篇-索引"><meta name="twitter:description" content="深入浅出索引索引的出现其实就是为了提高数据查询的效率，就像书的目录一样。索引的常见模型索引的出现是为了提高查询效率，但是实现索引的方式却是有很多钟，所以这里也就引入了索引模型的概念。可以用于提高读写效率的数据结构很多，常见也比较简单的数据结构，它们分别是哈希表、有序数组和搜索树哈希表是一种以键-值（key-value）存储数据的结构，我们只要输入待查找的值即key，就可以找到其对应的值Value。"><meta name="twitter:image" content="https://raw.githubusercontent.com/vincentxin-scott/img/master/picgo/20200201152517.png"><link rel="canonical" href="https://vincentxin-scott.github.io/2020/01/31/数据库/mysql｜04深入浅出索引/index.html"><link rel="alternate" href="/atom.xml" title="On The Way" type="application/atom+xml"><link rel="icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="https://jjeejj.github.io/css/gitment.css"></head><body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="slimContent"><div class="navbar-header"><div class="profile-block text-center"><a id="avatar" href="https://github.com/vincentxin-scott" target="_blank"><img class="img-circle img-rotate" src="/images/avatar.jpg" width="200" height="200"></a><h2 id="name" class="hidden-xs hidden-sm">Vincent Xin</h2><h3 id="title" class="hidden-xs hidden-sm hidden-md">从零开始的程序猿之路</h3><small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i> Huhhot, China</small></div><div class="search" id="search-form-wrap"><form class="search-form sidebar-form"><div class="input-group"><input type="text" class="search-form-input form-control" placeholder="搜索"> <span class="input-group-btn"><button type="submit" class="search-form-submit btn btn-flat" onclick="return!1"><i class="icon icon-search"></i></button></span></div></form><div class="ins-search"><div class="ins-search-mask"></div><div class="ins-search-container"><div class="ins-input-wrapper"><input type="text" class="ins-search-input" placeholder="想要查找什么..." x-webkit-speech> <button type="button" class="close ins-close ins-selectable" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button></div><div class="ins-section-wrapper"><div class="ins-section-container"></div></div></div></div></div><button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button></div><nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation"><ul class="nav navbar-nav main-nav"><li class="menu-item menu-item-home"><a href="/."><i class="icon icon-home-fill"></i> <span class="menu-title">首页</span></a></li><li class="menu-item menu-item-archives"><a href="/archives"><i class="icon icon-archives-fill"></i> <span class="menu-title">归档</span></a></li><li class="menu-item menu-item-categories"><a href="/categories"><i class="icon icon-folder"></i> <span class="menu-title">分类</span></a></li><li class="menu-item menu-item-tags"><a href="/tags"><i class="icon icon-tags"></i> <span class="menu-title">标签</span></a></li></ul><ul class="social-links"><li><a href="https://github.com/vincentxin-scott" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul></nav></div></header><aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><div class="widget"><h3 class="widget-title">公告</h3><div class="widget-body"><div id="board"><div class="content"><p>只有你很努力的时候，才能很安心!</p></div></div></div></div><div class="widget"><h3 class="widget-title">分类</h3><div class="widget-body"><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/DevOps/">DevOps</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java基础/">Java基础</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mac/">Mac</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring官方文档/">Spring官方文档</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/工作流/">工作流</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据库/">数据库</a><span class="category-list-count">27</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂记随笔/">杂记随笔</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/框架/">框架</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/第三方支付/">第三方支付</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络/">网络</a><span class="category-list-count">10</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/脚本语言/">脚本语言</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">3</span></li></ul></div></div><div class="widget"><h3 class="widget-title">标签</h3><div class="widget-body"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Activiti/">Activiti</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/">Docker</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Homebrew/">Homebrew</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HttpClient/">HttpClient</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Idea/">Idea</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JDK/">JDK</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jenkins/">Jenkins</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/">Linux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Lua/">Lua</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Markdown/">Markdown</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/">MySQL</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL-MariaDB-报错处理/">MySQL(MariaDB)报错处理</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OKHTTP/">OKHTTP</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Oh-my-zsh/">Oh-my-zsh</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/">Redis</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/">Spring</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot/">SpringBoot</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringCloud/">SpringCloud</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringSecurity/">SpringSecurity</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring文档/">Spring文档</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/lftp/">lftp</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mac/">mac</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/npm/">npm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nvm/">nvm</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shell/">shell</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/事务/">事务</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/微信支付/">微信支付</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/支付宝支付/">支付宝支付</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/线程/">线程</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/解决问题/">解决问题</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/设计模式/">设计模式</a><span class="tag-list-count">3</span></li></ul></div></div><div class="widget"><h3 class="widget-title">归档</h3><div class="widget-body"><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">14</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">一月 2020</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a><span class="archive-list-count">11</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">七月 2019</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">六月 2019</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">五月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">四月 2019</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a><span class="archive-list-count">4</span></li></ul></div></div><div class="widget"><h3 class="widget-title">最新文章</h3><div class="widget-body"><ul class="recent-post-list list-unstyled no-thumbnail"><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/工作流/">工作流</a></p><p class="item-title"><a href="/2020/04/17/Activiti/01｜先运行起来在说/" class="title">01｜SpringBoot整合Activiti Modeler</a></p><p class="item-date"><time datetime="2020-04-17T07:23:06.257Z" itemprop="datePublished">2020-04-17</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/Spring/">Spring</a></p><p class="item-title"><a href="/2020/03/20/SpringSecurity/01｜SpringSecurity介绍/" class="title">SpringSecurity介绍</a></p><p class="item-date"><time datetime="2020-03-20T14:58:00.476Z" itemprop="datePublished">2020-03-20</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/Linux/">Linux</a></p><p class="item-title"><a href="/2020/03/18/Linux/Linux中查看JDK安装路径/" class="title">在Linux中查看JDK安装路径</a></p><p class="item-date"><time datetime="2020-03-18T06:04:55.415Z" itemprop="datePublished">2020-03-18</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/杂记随笔/">杂记随笔</a></p><p class="item-title"><a href="/2020/03/18/杂记随笔/Linux中配置ssh密钥/" class="title">在Linux中配置ssh密钥</a></p><p class="item-date"><time datetime="2020-03-18T05:23:48.803Z" itemprop="datePublished">2020-03-18</time></p></div></li><li><div class="item-inner"><p class="item-category"><a class="category-link" href="/categories/数据库/">数据库</a></p><p class="item-title"><a href="/2020/03/16/数据库/mysql报错｜1153-max_allowed_packet问题处理/" class="title">Navicat 导入数据报错 --- 1153 - Got a packet bigger than &#39;max_allowed_packet&#39; bytes</a></p><p class="item-date"><time datetime="2020-03-16T15:31:24.999Z" itemprop="datePublished">2020-03-16</time></p></div></li></ul></div></div></div></aside><aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar"><div class="slimContent"><nav id="toc" class="article-toc"><h3 class="toc-title">文章目录</h3><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#深入浅出索引"><span class="toc-number">1.</span> <span class="toc-text">深入浅出索引</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#索引的常见模型"><span class="toc-number">1.1.</span> <span class="toc-text">索引的常见模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#哈希表"><span class="toc-number">1.1.1.</span> <span class="toc-text">哈希表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#有序数组"><span class="toc-number">1.1.2.</span> <span class="toc-text">有序数组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二叉搜索树"><span class="toc-number">1.1.3.</span> <span class="toc-text">二叉搜索树</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#InnoDB的索引模型"><span class="toc-number">1.2.</span> <span class="toc-text">InnoDB的索引模型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基于主键索引和普通索引的查询有什么区别？"><span class="toc-number">1.2.1.</span> <span class="toc-text">基于主键索引和普通索引的查询有什么区别？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#索引维护"><span class="toc-number">1.3.</span> <span class="toc-text">索引维护</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL语句重建索引"><span class="toc-number">1.3.1.</span> <span class="toc-text">SQL语句重建索引</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL索引有关概念"><span class="toc-number">1.4.</span> <span class="toc-text">MySQL索引有关概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#覆盖索引"><span class="toc-number">1.5.</span> <span class="toc-text">覆盖索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#在一个市民信息表上，是否有必要将身份证号和名字建立联合索引？"><span class="toc-number">1.5.1.</span> <span class="toc-text">在一个市民信息表上，是否有必要将身份证号和名字建立联合索引？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#最左前缀原则"><span class="toc-number">1.6.</span> <span class="toc-text">最左前缀原则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#索引下推"><span class="toc-number">1.7.</span> <span class="toc-text">索引下推</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#问题思考"><span class="toc-number">1.8.</span> <span class="toc-text">问题思考</span></a></li></ol></li></ol></nav></div></aside><main class="main" role="main"><div class="content"><article id="post-数据库/mysql｜04深入浅出索引" class="article article-type-post" itemscope itemtype="http://schema.org/BlogPosting"><div class="article-header"><h1 class="article-title" itemprop="name">MySQL基础篇-索引</h1><div class="article-meta"><span class="article-date"><i class="icon icon-calendar-check"></i> <a href="/2020/01/31/数据库/mysql｜04深入浅出索引/" class="article-date"><time datetime="2020-01-31T14:25:42.962Z" itemprop="datePublished">2020-01-31</time></a></span> <span class="article-category"><i class="icon icon-folder"></i> <a class="article-category-link" href="/categories/数据库/">数据库</a></span> <span class="article-tag"><i class="icon icon-tags"></i> <a class="article-tag-link" href="/tags/MySQL/">MySQL</a></span> <span class="article-read hidden-xs"><i class="icon icon-eye-fill" aria-hidden="true"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></span> <span class="post-comment"><i class="icon icon-comment"></i> <a href="/2020/01/31/数据库/mysql｜04深入浅出索引/#comments" class="article-comment-link">评论</a></span> <span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 3.1k(字)</span> <span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 11(分)</span></div></div><div class="article-entry marked-body" itemprop="articleBody"><h1 id="深入浅出索引"><a href="#深入浅出索引" class="headerlink" title="深入浅出索引"></a>深入浅出索引</h1><p>索引的出现其实就是为了提高数据查询的效率，就像书的目录一样。</p><h2 id="索引的常见模型"><a href="#索引的常见模型" class="headerlink" title="索引的常见模型"></a>索引的常见模型</h2><p>索引的出现是为了提高查询效率，但是实现索引的方式却是有很多钟，所以这里也就引入了索引模型的概念。可以用于提高读写效率的数据结构很多，常见也比较简单的数据结构，它们分别是哈希表、有序数组和搜索树</p><h3 id="哈希表"><a href="#哈希表" class="headerlink" title="哈希表"></a>哈希表</h3><p>是一种以键-值（key-value）存储数据的结构，我们只要输入待查找的值即key，就可以找到其对应的值Value。</p><p>这种数据结构的弊端：</p><ul><li>key经过hash换算，会出现同一个值的情况。需要使用链表来维护</li><li>哈希表这种结构适合用户只有等值查询的场景—-NoSQL引擎。</li></ul><h3 id="有序数组"><a href="#有序数组" class="headerlink" title="有序数组"></a>有序数组</h3><p>有序数组在等值查询和范围查询场景中的性能就都非常优秀</p><p>这种数据结构的弊端：</p><ul><li>查询方便但是更新数据的时候就麻烦了，在中间插入的时候就必须挪动后面所有的记录，成本很高。</li><li>有序数组索引只适用于静态存储引擎。</li></ul><h3 id="二叉搜索树"><a href="#二叉搜索树" class="headerlink" title="二叉搜索树"></a>二叉搜索树</h3><p>特点：每个节点的左儿子小于父节点，父节点又小于右儿子。时间复杂度O(log(N))</p><p>为了维持O(log(N))的查询复杂度，你就需要保持这颗树是平衡二叉树。为了做这个保证，更新的时间复杂度也是O(log(N))</p><blockquote><p>平衡二叉树：其中每一个节点的左子树和右子树的高度差至多等于1</p></blockquote><p>二叉树是搜索效率最高的，但是实际上大多数的数据库存储却并不使用二叉树。其原因是，索引不知存在内存中，还要写在磁盘上。</p><p>N叉树由于在读写上的性能又带你，以及适配磁盘的访问模式，已经被广泛应用在数据库引擎中了。</p><p>在MySQL中，索引是在存储引擎层实现的，所以并没有统一的索引标准，即不同存储引擎的索引的工作方式并不一样。而即使多个存储引擎支持同一种类型的索引，其底层的实现也可能不同。由于InnoDB存储引擎在MySQL数据库中使用最为广泛。</p><h2 id="InnoDB的索引模型"><a href="#InnoDB的索引模型" class="headerlink" title="InnoDB的索引模型"></a>InnoDB的索引模型</h2><p>InnoDB使用了B+树索引模型，所以数据都是存储在B+树中的。</p><p>每个索引在InnoDB里面对应一颗B+树。</p><p>假设，我们有一个主键列为ID的表，表中有字段K，并且存在k上有索引</p><p>建表语句：<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mysql&gt; create table T(</span><br><span class="line">id int primary key, </span><br><span class="line">k int not null, </span><br><span class="line">name varchar(16),</span><br><span class="line">index (k))engine=InnoDB;</span><br></pre></td></tr></table></figure><p></p><p><img src="https://raw.githubusercontent.com/vincentxin-scott/img/master/picgo/20200201152517.png" alt></p><p>表中R1～R5的（ID，K）值分别为(100,1)、(200,2)、(300,3)、(500,5)、(600,6)，两棵树的示例示意图</p><p>主键索引的叶子节点存储的是整行的数据。在InnoDB里，主键索引也被称为聚簇索引(clustered index).</p><p>非主键索引的叶子节点内容是主键的值。在InnoDB里，非主键索引也被称为二级索引(secondary index).</p><h3 id="基于主键索引和普通索引的查询有什么区别？"><a href="#基于主键索引和普通索引的查询有什么区别？" class="headerlink" title="基于主键索引和普通索引的查询有什么区别？"></a>基于主键索引和普通索引的查询有什么区别？</h3><ul><li>如果语句是select * from T where ID = 500，即主键查询方式，则只需要搜索ID这颗B+树；</li><li>如果语句是select * from T where K= 5 ，即普通索引查询方式，则需要先搜索K索引树，得到ID的值为500，再到ID索引树搜索一次。这个过程称为回表。</li></ul><p>也就是说，基于非主键索引的查询需要多扫描一棵索引树。因此，在应用中应该尽量使用主键查询。</p><h2 id="索引维护"><a href="#索引维护" class="headerlink" title="索引维护"></a>索引维护</h2><p>B+树为了维护索引有序性，在插入新值的时候需要做必要的维护，如果插入新的行ID值为700，则需要在R5的记录后面插入一个新记录。如果新插入的ID值为400，就相对麻烦了，需要逻辑上挪动后面的数据，空出位置。</p><p>更糟糕的情况是，如果R5所在的数据页已经满了，根据B+树的算法，这时候需要申请一个新的数据页，然后挪动部分数据过去。这个过程称为页的分裂。在这种情况下，性能自然会受到影响。</p><p>除了性能外，页分裂操作还影响数据页的利用率，原本放在一个页的数据，现在分到两个页中，整体空间利用率降低了50%。</p><p>当然有分裂就有合并。当相邻两个页由于删除了数据，利用率很低之后，会将数据页做合并。合并的过程，可以认为是的分裂过程的逆过程。</p><blockquote><p>在一些建表规范中见到过类似的描述，要求建表语句里一定要有自增主键。当然事无绝对，接下来分析一下哪些场景应该使用自增主键，而哪些场景下不应该。</p></blockquote><p>自增主键是指自增列上定义的主键，在建表语句中一般是这么定义的：NOT NULL PRIMARY KEY AUTO_INCREMENT.</p><p>插入新纪录的时候可以不指定ID的值，系统会获取当前ID最大值加1作为下一条 记录的ID值。</p><p>也就是说，自增主键的插入数据模式，正符合了我们前面提到的递增插入的场景。每次插入一条新纪录，都是追加操作，都不涉及到挪动其他的记录，也不会触发叶子节点的分裂。</p><p>而有业务逻辑的字段做主键，则往往不容易保证有序插入，这样写数据成本对象较高。</p><p>除了考虑性能外，我们还从存储空间的角度来看。假设你的表中确实有一个唯一字段，比如字符串类型的身份证号，那应该用身份证做主键，还是用自增字段做主键呢？</p><p>由于每个非主键索引的叶子节点上都是主键的值。如果用身份证好做主键，那么每个耳机索引的叶子节点占用约20个字符，而如果用整型做主键，则只要4个字符，如果是长整型(bigint)则是8个字符.</p><p><strong>显然，主键长度越小，普通索引的叶子节点就越小，普通索引占用的空间也就越小</strong></p><p>只有一个索引，该索引必须是唯一索引。这种情况下可以用业务字段直接做主键。</p><p>类似KV场景。</p><h3 id="SQL语句重建索引"><a href="#SQL语句重建索引" class="headerlink" title="SQL语句重建索引"></a>SQL语句重建索引</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> T <span class="keyword">drop</span> <span class="keyword">index</span> k;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> T <span class="keyword">add</span> <span class="keyword">index</span>(k);</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> T <span class="keyword">drop</span> primary <span class="keyword">key</span>;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> T <span class="keyword">add</span> primary <span class="keyword">key</span>(<span class="keyword">id</span>);</span><br></pre></td></tr></table></figure><p>重建主键是不合理的，不论是删除主键还是创建主键，都会将整个表重建。</p><p>可以用一句话代替<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> T <span class="keyword">engine</span> = <span class="keyword">InnoDB</span></span><br></pre></td></tr></table></figure><p></p><h2 id="MySQL索引有关概念"><a href="#MySQL索引有关概念" class="headerlink" title="MySQL索引有关概念"></a>MySQL索引有关概念</h2><p>我们要执行select * from T where K between 3 and 5，需要执行几次树的搜索操作，会扫描多少行？</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mysql&gt; create table T (</span><br><span class="line">ID int primary key,</span><br><span class="line">k int NOT NULL DEFAULT 0, </span><br><span class="line">s varchar(16) NOT NULL DEFAULT '',</span><br><span class="line">index k(k))</span><br><span class="line">engine=InnoDB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> T <span class="keyword">values</span>(<span class="number">100</span>,<span class="number">1</span>, <span class="string">'aa'</span>),(<span class="number">200</span>,<span class="number">2</span>,<span class="string">'bb'</span>),(<span class="number">300</span>,<span class="number">3</span>,<span class="string">'cc'</span>),(<span class="number">500</span>,<span class="number">5</span>,<span class="string">'ee'</span>),(<span class="number">600</span>,<span class="number">6</span>,<span class="string">'ff'</span>),(<span class="number">700</span>,<span class="number">7</span>,<span class="string">'gg'</span>);</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/vincentxin-scott/img/master/picgo/20200201153201.png" alt></p><p>这条SQL查询语句的执行流程：</p><ol><li>在k索引树上找到k=3的记录，取得ID=300；</li><li>再到ID搜索树查找到ID=300对应的R3；</li><li>在k索引树取下一个值k=5，取得ID=500；</li><li>再回到ID索引树查找到ID=500对应的R4；</li><li>在k索引树取下一个值k=6，不满主条件；</li><li>循环结束。</li></ol><p>在这个过程中，回到主键索引树搜索的过程，我们称为回表。（在实际生产中如何避免回表呢？）</p><h2 id="覆盖索引"><a href="#覆盖索引" class="headerlink" title="覆盖索引"></a>覆盖索引</h2><p>如果执行的语句是select ID from T where k between 3 and 5，这时只需要查询ID的值，而ID的值已经在k索引树上了，因此可以直接提供查询结果，不需要回表。也就是说，在这个查询里面，索引k已经覆盖了我们的查询需求，我们称为<strong>覆盖索引</strong></p><p>由于覆盖索引可以减少树的搜索次数，显著提升查询性能，所以使用覆盖索引是一个常用的性能优化手段。</p><p>在引擎内部使用覆盖索引在索引k上其实读了三个记录，R3～R5(对应的索引k上的记录项)，但是对于MySQL的server层来说，它就是找引擎拿到两条记录，因此MySQL认为扫描行数是2.</p><h3 id="在一个市民信息表上，是否有必要将身份证号和名字建立联合索引？"><a href="#在一个市民信息表上，是否有必要将身份证号和名字建立联合索引？" class="headerlink" title="在一个市民信息表上，是否有必要将身份证号和名字建立联合索引？"></a>在一个市民信息表上，是否有必要将身份证号和名字建立联合索引？</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`tuser`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`id_card`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`age`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`ismale`</span> <span class="built_in">tinyint</span>(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`id_card`</span> (<span class="string">`id_card`</span>),</span><br><span class="line">  <span class="keyword">KEY</span> <span class="string">`name_age`</span> (<span class="string">`name`</span>,<span class="string">`age`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span></span><br></pre></td></tr></table></figure><p>我们知道，身份证是使命的唯一标识。也就是说，如果根据身份证号查询市民信息的需求，我们只要身份证号字段上建立索引就够了。而在建立一个（身份证号、姓名）的联合索引，是不是浪费空间呢？</p><p>如果现在有一个高频请求，要根据市民身份证号码查询他的姓名，这个联合索引就有意义了。它可以在这个高频请求上用到覆盖索引，不再需要回表查整行记录，减少语句的执行时间。</p><h2 id="最左前缀原则"><a href="#最左前缀原则" class="headerlink" title="最左前缀原则"></a>最左前缀原则</h2><p>B+树这种索引结构，可以利用索引的“最左前缀”，来定位记录。</p><p>为了直观地说明这个概念，我们用（name，age）这个联合索引来分析。<br><img src="https://raw.githubusercontent.com/vincentxin-scott/img/master/picgo/20200201175059.png" alt></p><p>可以看到，索引项是按照索引定义里面出现的字段顺序排序的。</p><p>当逻辑需求是查到所有名字是“张三“的人时，可以快速定位到ID4，然后向后便利得到所有需要的结果。</p><p>如果你要查的所有名字第一个字是”张“的人，你的SQL语句的条件是where name like ‘张%’。这时，你也能够用上这个索引，查找到第一个符合条件的记录是ID3，然后向后遍历，直到不满足条件为止。</p><p>基于最左前缀索引的说明：</p><ul><li>第一原则，如果通过调整顺序，可以少维护一个索引，那么这个顺序往往就是需要优先考虑采用的。</li><li>联合索引，如果查询条件只有b的语句，是无法使用（a，b）这个联合索引的。</li><li>需要考虑的原则就是空间了。是否设置单字段索引b</li></ul><h2 id="索引下推"><a href="#索引下推" class="headerlink" title="索引下推"></a>索引下推</h2><p>满足最左前缀原则的情况下的查询，如果后面的查询条件中还有包含的联合索引的其他的值，则会利用联合索引进行索引下推去判断，而不会直接回表。</p><h2 id="问题思考"><a href="#问题思考" class="headerlink" title="问题思考"></a>问题思考</h2><p>当备库用-single-transaction做逻辑备份的时候，如果从主库的binlog传来一个DDL语句会怎么样？</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">Q1:<span class="keyword">SET</span> <span class="keyword">SESSION</span> <span class="keyword">TRANSACTION</span> <span class="keyword">ISOLATION</span> <span class="keyword">LEVEL</span> REPEATABLE <span class="keyword">READ</span>;</span><br><span class="line">Q2:<span class="keyword">START</span> <span class="keyword">TRANSACTION</span>  <span class="keyword">WITH</span> <span class="keyword">CONSISTENT</span> <span class="keyword">SNAPSHOT</span>；</span><br><span class="line"><span class="comment">/* other tables */</span></span><br><span class="line">Q3:<span class="keyword">SAVEPOINT</span> sp;</span><br><span class="line"><span class="comment">/* 时刻 1 */</span></span><br><span class="line">Q4:<span class="keyword">show</span> <span class="keyword">create</span> <span class="keyword">table</span> <span class="string">`t1`</span>;</span><br><span class="line"><span class="comment">/* 时刻 2 */</span></span><br><span class="line">Q5:<span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="string">`t1`</span>;</span><br><span class="line"><span class="comment">/* 时刻 3 */</span></span><br><span class="line">Q6:<span class="keyword">ROLLBACK</span> <span class="keyword">TO</span> <span class="keyword">SAVEPOINT</span> sp;</span><br><span class="line"><span class="comment">/* 时刻 4 */</span></span><br><span class="line"><span class="comment">/* other tables */</span></span><br></pre></td></tr></table></figure><ul><li><p>在备份开始的时候，为了确保RR隔离级别，在设置一次RR隔离级别(Q1)</p></li><li><p>启动事务，这里用with consistent snapshot确保这个语句执行完就可以得到一个一致性视图(Q2)</p></li><li><p>设置一个保存点，这个很重要(Q3)</p></li><li><p>show create 是为了拿到表结构(Q4),然后正式导数据(Q5),回滚导savepoint sp，在这里的作用是释放t1的MDL锁(Q6)。</p></li></ul><p>DDL从主库传递过来的时间按照效果不通，假设四个时刻。</p><ol><li>如果在Q4语句执行之前就到达，现象：没有影响，备份拿到的是DDL之后的表结构。</li><li>如果在“时刻2”到达，则表结果被改过，Q5执行的时候，报Table definition has changed，please retry transaction，现象：mysqldump终止；</li><li>如果在“时刻2”和“时刻3”之间到达的，mysqldump占着t1的MDL读锁，binlog被阻塞，现象：主从延迟，直到Q6执行完成。</li><li>从“时刻4”开始，mysqldump释放了MDL读锁，现象：没有影响，备份拿到的是DDL前的表结构。</li></ol></div><div class="article-footer"><blockquote class="mt-2x"><ul class="post-copyright list-unstyled"><li class="post-copyright-link hidden-xs"><strong>本文链接：</strong> <a href="https://vincentxin-scott.github.io/2020/01/31/数据库/mysql｜04深入浅出索引/" title="MySQL基础篇-索引" target="_blank" rel="external">https://vincentxin-scott.github.io/2020/01/31/数据库/mysql｜04深入浅出索引/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank" rel="external">CC BY 4.0 CN协议</a> 许可协议。转载请注明出处！</li></ul></blockquote><div class="panel panel-default panel-badger"><div class="panel-body"><figure class="media"><div class="media-left"><a href="https://github.com/vincentxin-scott" target="_blank" class="img-burn thumb-sm visible-lg"><img src="/images/avatar.jpg" class="img-rounded w-full" alt></a></div><div class="media-body"><h3 class="media-heading"><a href="https://github.com/vincentxin-scott" target="_blank"><span class="text-dark">Vincent Xin</span><small class="ml-1x">从零开始的程序猿之路</small></a></h3><div>努力变瘦的胖子。</div></div></figure></div></div></div></article><section id="comments"></section></div><nav class="bar bar-footer clearfix" data-stick-bottom><div class="bar-inner"><ul class="pager pull-left"><li class="prev"><a href="/2020/02/02/数据库/mysql｜05全局锁、表锁及行锁/" title="MySQL基础篇-全局锁、表锁及行锁"><i class="icon icon-angle-left" aria-hidden="true"></i><span>&nbsp;&nbsp;上一篇</span></a></li><li class="next"><a href="/2020/01/31/数据库/mysql｜03事务隔离/" title="MySQL基础篇-事务隔离"><span>下一篇&nbsp;&nbsp;</span><i class="icon icon-angle-right" aria-hidden="true"></i></a></li><li class="toggle-toc"><a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false" title="文章目录" role="button"><span>[&nbsp;</span><span>文章目录</span> <i class="text-collapsed icon icon-anchor"></i> <i class="text-in icon icon-close"></i> <span>]</span></a></li></ul><button type="button" class="btn btn-fancy btn-donate pop-onhover bg-gradient-warning" data-toggle="modal" data-target="#donateModal"><span>赏</span></button><div class="bar-right"><div class="share-component" data-sites="weibo,wechat" data-mobile-sites="weibo,qq,qzone"></div></div></div></nav><div class="modal modal-center modal-small modal-xs-full fade" id="donateModal" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content donate"><button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><div class="modal-body"><div class="donate-box"><div class="donate-head"><p>感谢您的支持，我会继续努力的!</p></div><div class="tab-content"><div role="tabpanel" class="tab-pane fade active in" id="alipay"><div class="donate-payimg"><img src="/images/donate/alipayimg.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开支付宝扫一扫，即可进行扫码打赏哦</p></div><div role="tabpanel" class="tab-pane fade" id="wechatpay"><div class="donate-payimg"><img src="/images/donate/wechatpayimg.png" alt="扫码支持" title="扫一扫"></div><p class="text-muted mv">扫码打赏，你说多少就多少</p><p class="text-grey">打开微信扫一扫，即可进行扫码打赏哦</p></div></div><div class="donate-footer"><ul class="nav nav-tabs nav-justified" role="tablist"><li role="presentation" class="active"><a href="#alipay" id="alipay-tab" role="tab" data-toggle="tab" aria-controls="alipay" aria-expanded="true"><i class="icon icon-alipay"></i> 支付宝</a></li><li role="presentation"><a href="#wechatpay" role="tab" id="wechatpay-tab" data-toggle="tab" aria-controls="wechatpay" aria-expanded="false"><i class="icon icon-wepay"></i> 微信支付</a></li></ul></div></div></div></div></div></div></main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter"><ul class="social-links"><li><a href="https://github.com/vincentxin-scott" target="_blank" title="Github" data-toggle="tooltip" data-placement="top"><i class="icon icon-github"></i></a></li><li><a href="/atom.xml" target="_blank" title="Rss" data-toggle="tooltip" data-placement="top"><i class="icon icon-rss"></i></a></li></ul><div class="copyright"><div class="publishby">Theme by <a href="https://github.com/cofess" target="_blank">cofess </a>base on <a href="https://github.com/cofess/hexo-theme-pure" target="_blank">pure</a>.</div></div></footer><script src="//cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script><script>window.jQuery||document.write('<script src="js/jquery.min.js"><\/script>')</script><script src="/js/plugin.min.js"></script><script src="/js/application.js"></script><script>!function(T){var N={TRANSLATION:{POSTS:"文章",PAGES:"页面",CATEGORIES:"分类",TAGS:"标签",UNTITLED:"(未命名)"},ROOT_URL:"/",CONTENT_URL:"/content.json"};T.INSIGHT_CONFIG=N}(window)</script><script src="/js/insight.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><link rel="stylesheet" href="https://jjeejj.github.io/css/gitment.css"><script src="https://jjeejj.github.io/js/gitment.js"></script><script>var gitment=new Gitment({id:"Fri Jan 31 2020 22:25:42 GMT+0800",owner:"vincentxin-scott",repo:"vincentxin-scott.github.io",oauth:{client_id:"bdbd787b33e959dde648",client_secret:"e7d3f2e10d7a8d4e384c2a9765a5180ed4a92ad0"}});gitment.render("comments")</script></body></html><!-- rebuild by neat -->